jQuery(document).ready((e=>{if("woocommerce_page_wc-settings"!==(window.pagenow||""))return;window.serialize_form=s=>{let a=e(s).serializeArray();return a=e.grep(a,(e=>"_wp_http_referer"!==e.name&&"_wpnonce"!==e.name)),a.sort(((e,s)=>e.name>s.name?1:-1)),a};var s,a,t=new window.URLSearchParams(window.location.search);let r,c=e("#wc_square_location_id, #wc_square_sandbox_location_id").val(),n=e(".wc_square_save_changes_message");"square"!==t.get("tab")||t.get("section")&&""===t.get("section")||(a=serialize_form(e("#mainform"))),e(document).on("change",(function(s,a){if(a)return;const t=e("#wc_square_import_products").closest("tr");r&&c&&c.length?t.show():t.hide()})),e("#mainform :input").on("change",(function(t,r){if(r)return;const c=e("#wc_square_import_products");if(s=serialize_form("#mainform"),JSON.stringify(a)!==JSON.stringify(s)){if("wc_square_sandbox_location_id"===t.target.name||"wc_square_location_id"===t.target.name)return;n.show(),c.addClass("disabled")}else n.hide(),c.removeClass("disabled")})),e("#wc_square_sandbox_location_id, #wc_square_location_id").on("change",(function(){c=e(this).val()})),wc_square_admin_settings.is_sandbox||(e("#wc_square_sandbox_settings").hide(),e("#wc_square_sandbox_settings").next().hide(),e(".wc_square_sandbox_settings").closest("tr").hide()),e("#wc_square_system_of_record").on("change",(s=>{const a=e(s.target).val(),t=e("#wc_square_enable_inventory_sync"),c=t.closest("tr"),n=e("#wc_square_import_products").closest("tr"),o=e("#wc_square_override_product_images").closest("tr"),i=e("#wc_square_sync_interval").closest("tr");"square"===a||"woocommerce"===a?(r=!0,t.next("span").html(wc_square_admin_settings.i18n.sync_inventory_label[a]),c.find(".description").html(wc_square_admin_settings.i18n.sync_inventory_description[a]),c.show(),n.show(),i.show()):(r=!1,t.prop("checked",!1),c.hide(),n.hide(),o.hide(),i.hide()),"square"===a?(e("#wc_square_hide_missing_products").closest("tr").show(),o.show()):(e("#wc_square_hide_missing_products").closest("tr").hide(),o.hide())})).trigger("change",[!0]),e(".js-import-square-products").on("click",(function(s){s.preventDefault(),e(this).hasClass("disabled")||(new e.WCBackboneModal.View({target:"wc-square-import-products"}),e("#btn-close").on("click",(s=>{s.preventDefault(),e("button.modal-close").trigger("click")})))})),e("#wc-square-sync").on("click",(s=>{s.preventDefault(),new e.WCBackboneModal.View({target:"wc-square-sync"}),e("#btn-close").on("click",(s=>{s.preventDefault(),e("button.modal-close").trigger("click")}))})),e(document.body).on("wc_backbone_modal_response",((s,a)=>{let t;switch(a){case"wc-square-import-products":e("#wpbody").block({message:null,overlayCSS:{opacity:"0.2"},onBlock:function(){e(".blockUI.blockOverlay").css({position:"fixed"})}});const s=e("#wc-square-import-product-updates").prop("checked");t={action:"wc_square_import_products_from_square",security:wc_square_admin_settings.import_products_from_square,update_during_import:s},e.post(wc_square_admin_settings.ajax_url,t,(e=>{const s=e.data?e.data:null;s&&alert(s),location.href="admin.php?page=wc-settings&tab=square&section=update"}));break;case"wc-square-sync":e("table.sync").block({message:null,overlayCSS:{opacity:"0.2"}}),e("table.records").block({message:null,overlayCSS:{opacity:"0.2"}}),e("#wc-square_clear-sync-records").prop("disabled",!0),t={action:"wc_square_sync_products_with_square",security:wc_square_admin_settings.sync_products_with_square},e.post(wc_square_admin_settings.ajax_url,t,(s=>{s&&s.success?location.reload():(e("#wc-square_clear-sync-records").prop("disabled",!1),e("table.sync").unblock(),e("table.records").unblock())}))}}));const o='<tr><td colspan="4"><em>'+wc_square_admin_settings.i18n.no_records_found+"</em></td></tr>";e("#wc-square_clear-sync-records").on("click",(s=>{s.preventDefault(),e("table.records").block({message:null,overlayCSS:{opacity:"0.2"}});const a={action:"wc_square_handle_sync_records",id:"all",handle:"delete",security:wc_square_admin_settings.handle_sync_with_square_records};e.post(wc_square_admin_settings.ajax_url,a,(s=>{s&&s.success?(e("table.records tbody").html(o),e("#wc-square_clear-sync-records").prop("disabled",!0)):(s.data&&alert(s.data),console.log(s)),e("table.records").unblock()}))})),e(".records .actions button.action").on("click",(s=>{s.preventDefault(),e("table.records").block({message:null,overlayCSS:{opacity:"0.2"}});const a=e(s.currentTarget).data("id"),t=e(s.currentTarget).data("action"),r={action:"wc_square_handle_sync_records",id:a,handle:t,security:wc_square_admin_settings.handle_sync_with_square_records};e.post(wc_square_admin_settings.ajax_url,r,(s=>{if(s&&s.success){const s="#record-"+a;"delete"===t?(e(s).remove(),e("table.records tbody tr").length||(e("table.records tbody").html(o),e("#wc-square_clear-sync-records").prop("disabled",!0))):"resolve"!==t&&"unsync"!==t||(e(s+" .type").html('<mark class="resolved"><span>'+wc_square_admin_settings.i18n.resolved+"</span></mark>"),e(s+" .actions").html("&mdash;"))}else s&&s.data&&alert(s.data),console.log({record:a,action:t,response:s});e("table.records").unblock()}))})),e("form").on("submit",(s=>{const a=e("#wc_square_enable_sandbox").is(":checked")?"sandbox":"production";e(s.target).append(e("<input>",{type:"hidden",name:"wc_square_environment",value:a}))})),wc_square_admin_settings.existing_sync_job_id&&(s=>{let a=e("span.progress");a&&0!==a.length||(e("p.sync-result").append(' <span class="progress" style="display:block"></span>'),a=e("span.progress"));const t={action:"wc_square_get_sync_with_square_status",security:wc_square_admin_settings.get_sync_with_square_status_nonce,job_id:s};e.post(wc_square_admin_settings.ajax_url,t,(s=>{if(s&&s.data)if(s.success&&s.data.id)if(e("table.sync .spinner").css("visibility","visible"),e("#wc-square_clear-sync-records").prop("disabled",!0),e("table.records .actions button").prop("disabled",!0),"completed"!==s.data.status&&"failed"!==s.data.status){let e=" ";"product_import"===s.data.action?(e+=wc_square_admin_settings.i18n.skipped+": "+parseInt(s.data.skipped_products_count,10)+"<br/>",e+=wc_square_admin_settings.i18n.updated+": "+parseInt(s.data.updated_products_count,10)+"<br/>",e+=wc_square_admin_settings.i18n.imported+": "+parseInt(s.data.imported_products_count,10)):s.data.percentage&&(e+=parseInt(s.data.percentage,10)+"%"),a.html(e),setTimeout((()=>{location.reload()}),3e4)}else location.reload();else e("#wc-square_clear-sync-records").prop("disabled",!1),e("table.records .actions button").prop("disabled",!1),e("table.sync .spinner").css("visibility","hidden"),console.log(s)}))})(wc_square_admin_settings.existing_sync_job_id),e("#woocommerce_square_credit_card_enable_digital_wallets").on("change",(()=>{const s=e(".wc-square-digital-wallet-options");e("#woocommerce_square_credit_card_enable_digital_wallets").is(":checked")?s.closest("tr").show():s.closest("tr").hide()})).trigger("change",[!1])}));